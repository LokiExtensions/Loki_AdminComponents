<?php
declare(strict_types=1);

use Loki\Components\Factory\ViewModelFactory;
use Magento\Framework\View\Element\Template;

/** @version 0.4.4 */
/** @var Template $block */
/** @var ViewModelFactory $viewModelFactory */

$ajaxUrl =  $block->getUrl('mui/index/render') . '?'.http_build_query([
    'namespace' => 'customer_listing',
    'sorting[field]' => 'entity_id',
    'sorting[direction]' => 'asc',
    'keywordUpdated' => false,
    'filters[placeholder]' => true,
    'paging[pageSize]' => 20,
    'paging[current]' => 1,
    'isAjax' => 'true',
]);

?>
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('LokiAdminFormEntitySelectComponent', () => ({
            isModalWrapperVisible: false,
            currentEntityCode: '',
            currentEntityLabel: '',
            totalEntities: 0,
            valueCode: 'value',
            search: '',
            entities: [],
            init() {
                this.valueCode = this.$root.getAttribute('data-value-code');

                if (this.isModalWrapperVisible) {
                    this.loadEntities();
                }

                this.$watch('search', () => {
                    this.loadEntities();
                });
            },
            setSearch(event) {
                this.search = event.target.value;
            },
            hasEntities() {
                return this.totalEntities > 0;
            },
            hasNoEntities() {
                return !this.hasEntities();
            },
            loadEntities() {
                let ajaxUrl = this.getAjaxUrl();
                if (this.search) {
                    ajaxUrl += '&search=' + this.search;
                }

                fetch(ajaxUrl, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        this.entities = data.items;
                        this.totalEntities = data.totalRecords;
                    })
                    .catch(error => {
                        console.error('Fetch error:', error);
                    });
            },
            getAjaxUrl() {
                return '<?= $ajaxUrl ?>';
            },
            showModalWrapper() {
                this.loadEntities();
                this.isModalWrapperVisible = true;
                document.getElementsByTagName('body')[0].classList.add('_has-modal');
                this.$refs.aside.classList.add('_show');
            },
            closeWrapper() {
                this.isModalWrapperVisible = false;
                document.getElementsByTagName('body')[0].classList.remove('_has-modal');
                this.$refs.aside.classList.remove('_show');
            },
            setNested(obj, path, value) {
                const parts = path.split(".");
                let current = obj;

                for (let i = 0; i < parts.length - 1; i++) {
                    if (current[parts[i]] == null) {
                        current[parts[i]] = {};
                    }
                    current = current[parts[i]];
                }

                current[parts[parts.length - 1]] = value;
            },
            selectEntity(entity) {
                const value = entity[entity.id_field_name];
                this.setNested(this, this.valueCode, value);
                this.currentEntityLabel = entity[entity.name];
                this.closeWrapper();
            }
        }));
    });
</script>
